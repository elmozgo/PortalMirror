<html>

<body>
    
    <script>
        window.wsTokenSettings = window.wsTokenSettings || {
           
            nodeWsUrl: "ws://localhost:3000",
            tokenLocation: "http://localhost:8081/mock/token"
            
        }
    </script>
    <script src="./portletws.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
         
    function SocketConnection(namespace, portletName, pageId) {
        this.namespace = namespace;
        this.portletName = portletName;
        this.pageId = pageId;
    };
    
    SocketConnection.prototype = {
        
        socket: null,
        connectTimeout: 1000,
        reconnect: true,
        reconnectionDelay: 300,
        authToken: null,
        
        configure: function() {
            this.socket =  io(wsTokenSettings.nodeWsUrl + '/' + this.namespace, {
                'connect timeout': this.connectTimeout,
                'reconnect': this.reconnect,
                'reconnection delay': this.reconnectionDelay,
            });
        },

        onConnect: function(socket) {
                socket.emit('authenticate', {token: this.authToken})
               .on('authenticated', function () {
                    console.log('authenticated')
                })
                .on('unauthorized', function(msg) {
                    console.log("unauthorized: " + JSON.stringify(msg.data));
                    throw new Error(msg.data.type);
                });
        },

        init: function(afterConnected) {
            var that = this;
            jQuery.ajax({
                url: wsTokenSettings.tokenLocation + '?portletName=' + this.portletName + '&pageId=' + this.pageId,
                success: function (data) {
                    that.authToken = data;
                    that.configure();
                    that.socket.on('connect', that.onConnect.bind(that, that.socket));
                    afterConnected.call(that);
                }
            });
        }
    };

    
    function RefresherSocketConnection(portletName, pageId) {
        SocketConnection.call(this, 'refresher', portletName, pageId);
    }

    RefresherSocketConnection.prototype = Object.create(SocketConnection.prototype, {
        init: {
            value: function() {
                    SocketConnection.prototype.init.call(this, function() {
                        this.socket.on('refreshEvent', function(message, callback) {
                            callback('refreshed :' + document.getElementById('text').innerHTML);
                            location.reload(true);
                        });
                    });
            },
            enumerable: true,
            configurable: true, 
            writable: true
        }
    });

    RefresherSocketConnection.prototype.constructor = RefresherSocketConnection;


    var refresherSocketConnection = new RefresherSocketConnection('test', 'test');
    refresherSocketConnection.init();
    

//     function setupConnection(socket, portletName, pageId) {
//         socket = io(wsTokenSettings.nodeWsUrl + '/refresher', {
//             'connect timeout': 10000,
//             'reconnect': true,
//             'reconnection delay': 300,
//             });

             
//         jQuery.ajax({
//             url: wsTokenSettings.tokenLocation + '?portletName=' + portletName + '&pageId=' + pageId,
//             success: function (data) {
//                 var jwt = data;

//                 socket.on('connect', function (){
//                 socket.emit('authenticate', {token: jwt})
//                 .on('authenticated', function () {
//                     console.log('authenticated')
//                 })
//                 .on('unauthorized', function(msg) {
//                     console.log("unauthorized: " + JSON.stringify(msg.data));
//                     throw new Error(msg.data.type);
//                 });
//                });
//              }

//     });
    
//     return jwtToken;
// } 
//         var jwt = getJwtToken('test');
        
//         var socket = io(wsTokenSettings.nodeWsUrl + '/refresher', {
//             'connect timeout': 1000,
//             'reconnect': true,
//             'reconnection delay': 300,
//         });
        
        
//         // Authentication failed 
//         socket.on('error', function (err) {
            
//             if(err == 'tokenExpiredError' ) {
//                 console.log('expired token: ' + token)
//                 token = getJwtToken('');
//             } else {
//                 throw new Error(err);   
//             }
//         });
        
//         // Authentication passed 
//         socket.on('success', function (data) {
//             console.log(data.message);
//             console.log('user info: ' + data.user);
// //         });
        
//         socket.on('refreshEvent', function(message, callback) {
            
//             callback('refreshed :' + document.getElementById('text').innerHTML);

//             location.reload(true);
//         });
        
//         var socketClient = socket.connect('');
        
    </script>
    
    <p id="text"></p>
    
    <script>
        document.getElementById('text').innerHTML = Date.now();
    </script>
    
</body>
    
   
    

</html>